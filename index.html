<style>
    /* Khung n·ªÅn m·ªù */
    #replyPopup {
        display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 99999; /* Cao nh·∫•t ƒë·ªÉ ƒë√® l√™n m·ªçi th·ª© */
        justify-content: center;
        align-items: center;
        flex-direction: column;
        animation: fadeIn 0.3s;
    }

    /* H·ªôp n·ªôi dung ch√≠nh */
    .reply-content {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        width: 90%;
        max-width: 400px;
        border: 4px solid #ff4d6d;
        box-shadow: 0 0 20px rgba(255, 77, 109, 0.5);
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .reply-title {
        font-family: "Baloo 2", cursive;
        color: #ff4d6d;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0;
    }

    /* √î nh·∫≠p li·ªáu */
    #replyInput {
        width: 100%;
        height: 120px;
        padding: 10px;
        border: 2px solid #ffccd5;
        border-radius: 10px;
        font-family: "Baloo 2", sans-serif;
        font-size: 1.1rem;
        resize: none;
        outline: none;
        color: #333;
    }
    #replyInput:focus { border-color: #ff4d6d; }

    /* N√∫t b·∫•m */
    .action-btn {
        padding: 10px 0;
        border-radius: 25px;
        border: none;
        font-family: "Baloo 2", cursive;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }
    .btn-send { background-color: #ff4d6d; color: white; }
    .btn-send:hover { background-color: #e63c5e; }
    .btn-cancel { background-color: #eee; color: #666; }

    /* Hi·ªáu ·ª©ng tay ch·ªâ v√†o ch·ªØ I Love You */
    .love-message { cursor: pointer; transition: transform 0.2s; }
    .love-message:hover { transform: scale(1.1); }
</style>

<div id="replyPopup">
    <div class="reply-content">
        <h3 class="reply-title">G·ª≠i l·ªùi nh·∫Øn cho anh ‚ù§Ô∏è</h3>
        <textarea id="replyInput" placeholder="Vi·∫øt g√¨ ƒë√≥ v√†o ƒë√¢y nh√©..."></textarea>
        <button id="btnSendReply" class="action-btn btn-send">G·ª≠i ngay üíå</button>
        <button class="action-btn btn-cancel" onclick="document.getElementById('replyPopup').style.display='none'">ƒê·ªÉ sau</button>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH ---
    const UPLOAD_PRESET = 'ml_default'; // T√™n preset (Nh·ªõ b·∫≠t Unsigned tr√™n Cloudinary nh√©)
    const CLOUD_NAME = 'dkcgsjtls';     // T√™n cloud c·ªßa b·∫°n

    document.addEventListener('DOMContentLoaded', () => {
        const loveMsgElement = document.querySelector('.love-message');
        const replyPopup = document.getElementById('replyPopup');
        const replyInput = document.getElementById('replyInput');
        const btnSend = document.getElementById('btnSendReply');

        // B·∫Øt s·ª± ki·ªán click v√†o ch·ªØ "I LOVE YOU 3000"
        if(loveMsgElement && replyPopup) {
            loveMsgElement.addEventListener('click', () => {
                replyPopup.style.display = 'flex';
                if(replyInput) replyInput.focus();
            });
        }

        // X·ª≠ l√Ω khi b·∫•m n√∫t G·ª≠i
        if(btnSend) {
            btnSend.addEventListener('click', async () => {
                const text = replyInput.value.trim();
                if (!text) {
                    alert("ƒê·ª´ng ƒë·ªÉ tr·ªëng nha üò¢");
                    return;
                }

                // Kh√≥a n√∫t ƒë·ªÉ tr√°nh b·∫•m nhi·ªÅu l·∫ßn
                const originalText = btnSend.innerText;
                btnSend.innerText = "ƒêang g·ª≠i...";
                btnSend.disabled = true;

                try {
                    // T·∫°o t√™n file theo th·ªùi gian th·ª±c
                    const now = new Date();
                    const timeStr = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}_${now.getHours()}h${now.getMinutes()}`;
                    const fileName = `reply_${timeStr}.txt`;
                    
                    const file = new File([text], fileName, { type: "text/plain" });

                    // G√≥i d·ªØ li·ªáu
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', UPLOAD_PRESET);
                    formData.append('folder', userId + '/replies'); 

                    // G·ª≠i l√™n Cloudinary
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/raw/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.error) throw new Error(data.error.message);

                    // Th√†nh c√¥ng
                    alert("ƒê√£ g·ª≠i l·ªùi nh·∫Øn th√†nh c√¥ng! Y√™u em ‚ù§Ô∏è");
                    replyPopup.style.display = 'none';
                    replyInput.value = ""; 

                } catch (error) {
                    console.error('L·ªói upload:', error);
                    alert("L·ªói: " + error.message + "\n(H√£y ki·ªÉm tra xem ml_default ƒë√£ b·∫≠t Unsigned ch∆∞a nh√©!)");
                } finally {
                    btnSend.innerText = originalText;
                    btnSend.disabled = false;
                }
            });
        }
    });
</script>
